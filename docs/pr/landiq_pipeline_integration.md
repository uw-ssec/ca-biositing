# PR: Land IQ Pipeline Integration and PostGIS Setup

## Overview

This PR implements the Land IQ ETL pipeline, enabling the extraction,
transformation, and loading of Land IQ geospatial crop mapping data into the
PostgreSQL database. It also includes critical schema updates for the `Polygon`
and `LandiqRecord` models to support robust data ingestion and PostGIS
integration.

## Key Changes

### 1. Land IQ ETL Pipeline

- **Extract**: Implemented shapefile extraction using `geopandas` in
  `ca_biositing.pipeline.etl.extract.landiq`.
- **Transform**:
  - Fixed an `AttributeError` caused by duplicate column names in the source
    data by implementing robust `.iloc` indexing.
  - Added mapping for `UniqueID` to `record_id` to ensure proper lineage
    tracking.
  - Implemented automatic column deduplication during the cleaning phase.
- **Load**:
  - Refactored the loading logic to use SQLAlchemy ORM-based "check-then-upsert"
    patterns.
  - This bypasses issues with missing database-level unique constraints and
    prevents `ON CONFLICT` failures.

### 2. Schema & Model Updates

- **Polygon Model**: Updated the LinkML schema to use a surrogate integer `id`
  as the primary key instead of the geometry string (`geom`). This improves join
  performance and aligns with PostGIS best practices.
- **LandiqRecord Model**: Ensured `record_id` is correctly handled as a natural
  key while maintaining a surrogate `id` for database internal use.
- **Generated Models**: Patched the generated SQLAlchemy models to correctly
  reflect `primary_key` and `autoincrement` status for surrogate IDs.

### 3. PostGIS Integration & Migration

- **PostGIS Setup**: The database now supports PostGIS for advanced geospatial
  queries.
- **Migration `823ec0ea8e4e`**:
  - Handles the transition of `polygon_id` from `TEXT` to `INTEGER`.
  - Manually adjusted to respect PostGIS dependencies (preventing accidental
    drops of `spatial_ref_sys`).
  - Implements safe type casting for existing data using `USING NULL` to reset
    foreign keys during the schema transition.

## Installation & Setup

### PostGIS Installation

PostGIS is included in the project's Docker orchestration. To ensure it is
active:

1. **Rebuild Services**:
   ```bash
   pixi run rebuild-services
   ```
2. **Apply Migrations**:
   ```bash
   pixi run migrate
   ```
   _Note: The migration automatically handles the necessary schema adjustments
   for geospatial data._

### Running the Land IQ Pipeline

#### 1. Download Data

The Land IQ shapefiles are not included in the repository due to their size.

1. Download the Land IQ shapefile from
   [Land IQ Land Use Mapping](https://www.landiq.com/land-use-mapping).
2. Extract and place the files in the `data/landiq/` directory.
   - Expected path: `data/landiq/i15_Crop_Mapping_2023_Provisional.shp` (and
     associated `.shx`, `.dbf`, etc.)

#### 2. Execute Flow

To run the Land IQ ETL flow:

```bash
# Ensure services are running
pixi run start-services

# Run the flow via the Prefect runner
python resources/prefect/run_prefect_flow.py
```

## Technical Notes

- **Autoflush**: The Land IQ loader now explicitly disables `autoflush` during
  the record loop to prevent `NotNullViolation` errors on surrogate IDs before
  they are generated by the database.
- **Normalization**: The `normalize_dataframes` utility was updated to
  dynamically detect primary keys, ensuring that name-to-ID swaps work correctly
  for models with non-standard identifiers.
