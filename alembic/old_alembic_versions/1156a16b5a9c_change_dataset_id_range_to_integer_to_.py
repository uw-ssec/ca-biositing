"""Change dataset_id range to integer to simplify schema

Revision ID: 1156a16b5a9c
Revises: f43c0177d889
Create Date: 2026-01-19 21:26:49.574453

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '1156a16b5a9c'
down_revision: Union[str, Sequence[str], None] = 'f43c0177d889'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    # We manually fix the foreign keys to point to 'dataset' instead of 'data_source'
    # for all tables that were incorrectly generated by LinkML.
    tables = [
        'aim1_record_base', 'aim2_record_base', 'facility_record',
        'landiq_record', 'usda_census_record', 'usda_market_record', 'usda_survey_record'
    ]
    for table in tables:
        fk_name = f"{table}_dataset_id_fkey"
        # Drop the incorrect constraint if it exists
        op.execute(f"ALTER TABLE {table} DROP CONSTRAINT IF EXISTS {fk_name}")
        # Create the correct one
        op.create_foreign_key(fk_name, table, 'dataset', ['dataset_id'], ['id'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    tables = [
        'aim1_record_base', 'aim2_record_base', 'facility_record',
        'landiq_record', 'usda_census_record', 'usda_market_record', 'usda_survey_record'
    ]
    for table in tables:
        fk_name = f"{table}_dataset_id_fkey"
        op.drop_constraint(fk_name, table, type_='foreignkey')
        op.create_foreign_key(fk_name, table, 'data_source', ['dataset_id'], ['id'])
    # ### end Alembic commands ###
